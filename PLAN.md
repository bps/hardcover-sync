# Hardcover Sync Plugin - Implementation Plan

A Calibre plugin for bidirectional sync with Hardcover.app, inspired by the Goodreads Sync plugin architecture but adapted for Hardcover's GraphQL API.

## Overview

- **Authentication**: API Key (from https://hardcover.app/account/api)
- **API Format**: GraphQL via `gql[requests]` library
- **Identifier**: `hardcover` (book ID) and `hardcover-edition` (edition ID)
- **Sync Direction**: Bidirectional (Calibre ↔ Hardcover)
- **Book Creation**: Link only (no creating new books on Hardcover)

## Hardcover Reading Statuses

| ID | Status |
|----|--------|
| 1 | Want to Read |
| 2 | Currently Reading |
| 3 | Read |
| 4 | Paused |
| 5 | Did Not Finish |
| 6 | Ignored |

## Data Mapping

| Hardcover Field | Calibre Storage | Suggested Column |
|-----------------|-----------------|------------------|
| Book ID | Identifier: `hardcover` | - |
| Edition ID | Identifier: `hardcover-edition` | - |
| Status (1-6) | Custom enumeration column | `#hc_status` |
| Rating (0-5) | Rating column | `#hc_rating` |
| Progress (pages) | Custom integer column | `#hc_progress` |
| Date Started | Custom datetime column | `#hc_date_started` |
| Date Read | Custom datetime column | `#hc_date_read` |
| Review | Custom comments column | `#hc_review` |
| Lists | Tags or custom column | `tags` or `#hc_lists` |

Users manually create custom columns, then map them in plugin configuration (following Goodreads Sync pattern).

## Menu Structure

```
Hardcover (toolbar button)
├── Set Status →
│   ├── Want to Read
│   ├── Currently Reading
│   ├── Read
│   ├── Paused
│   ├── Did Not Finish
│   └── ─────────────
│   └── Remove from Hardcover
├── Update Reading Progress...
├── ─────────────
├── Sync from Hardcover...
├── Sync to Hardcover...
├── ─────────────
├── Lists →
│   ├── Add to List...
│   ├── Remove from List...
│   └── ─────────────
│   └── View Lists on Hardcover
├── ─────────────
├── Link to Hardcover...
├── View on Hardcover
├── Remove Hardcover Link
├── ─────────────
├── Customize plugin...
└── Help
```

## Conflict Resolution

When syncing bidirectionally and values differ:

| Strategy | Description |
|----------|-------------|
| `ask` | Ask user each time (default) |
| `hardcover` | Always use Hardcover value |
| `calibre` | Always use Calibre value |
| `newest` | Use whichever was updated more recently |

## Project Structure

```
plugins/hardcover-sync/
├── .calibre/
│   ├── justfile              # Calibre source download/setup
│   └── .gitignore
├── src/hardcover_sync/
│   ├── __init__.py           # InterfaceActionBase plugin entry
│   ├── _version.py           # Auto-generated by versioningit
│   ├── action.py             # InterfaceAction (menus, toolbar)
│   ├── config.py             # Configuration UI + prefs storage
│   ├── api.py                # HardcoverAPI client (using gql)
│   ├── queries.py            # GraphQL queries/mutations
│   ├── models.py             # Data classes
│   ├── cache.py              # ID caching (Hardcover ↔ Calibre)
│   ├── matcher.py            # Book matching logic
│   └── dialogs/
│       ├── __init__.py
│       ├── common.py         # Shared dialog utilities
│       ├── sync_from.py      # Sync from Hardcover dialog
│       ├── sync_to.py        # Sync to Hardcover dialog
│       ├── link_book.py      # Link to Hardcover dialog
│       ├── progress.py       # Update progress dialog
│       └── lists.py          # Manage lists dialog
├── images/
│   └── hardcover_sync.png    # Plugin icon
├── test/
│   ├── conftest.py
│   ├── test_api.py
│   ├── test_matcher.py
│   └── fixtures/
├── scripts/
│   ├── build_env.py
│   ├── bundle.sh
│   └── bump.sh
├── shims/
│   └── pytest
├── .gitignore
├── .gitlint
├── .lefthook.yml
├── cliff.toml
├── justfile
├── mise.toml
├── pyproject.toml
└── README.md
```

## Implementation Phases

### Phase 1: Project Setup
- [ ] `mise.toml` - Tool versions (Python 3.11, uv, just, git-cliff)
- [ ] `pyproject.toml` - Package config, dependencies
- [ ] `justfile` - Development tasks
- [ ] `.calibre/justfile` - Calibre source setup
- [ ] `scripts/bundle.sh` - Create distributable .zip
- [ ] `.lefthook.yml`, `.gitlint`, `cliff.toml` - Git hooks & changelog
- [ ] `.gitignore`
- [ ] `shims/pytest` - Pytest wrapper

### Phase 2: Plugin Skeleton
- [ ] `src/hardcover_sync/__init__.py` - InterfaceActionBase
- [ ] `src/hardcover_sync/action.py` - InterfaceAction with basic menu
- [ ] `src/hardcover_sync/config.py` - Configuration widget stub
- [ ] `images/hardcover_sync.png` - Placeholder icon
- [ ] Verify plugin loads in Calibre

### Phase 3: API Client
- [ ] `src/hardcover_sync/api.py` - HardcoverAPI class
- [ ] `src/hardcover_sync/queries.py` - GraphQL queries
- [ ] `test/test_api.py` - Mocked API tests
- [ ] Token validation in config UI

### Phase 4: Book Linking
- [ ] `src/hardcover_sync/matcher.py` - ISBN lookup, title search
- [ ] `src/hardcover_sync/cache.py` - ID cache management
- [ ] `src/hardcover_sync/dialogs/link_book.py` - Link dialog
- [ ] Store `hardcover` identifier

### Phase 5: Set Reading Status
- [ ] Status submenu with all 6 statuses
- [ ] Call API to update status
- [ ] Update Calibre status column

### Phase 6: Configuration UI
- [ ] Token input + validation
- [ ] Column mapping dropdowns
- [ ] Status value mapping
- [ ] Conflict resolution setting

### Phase 7: Sync from Hardcover
- [ ] Fetch user's library
- [ ] Match to Calibre books
- [ ] Preview dialog
- [ ] Apply changes with conflict handling

### Phase 8: Sync to Hardcover
- [ ] Read Calibre values
- [ ] Preview dialog
- [ ] Push to API

### Phase 9: Progress & Lists
- [ ] Update progress dialog
- [ ] Add/remove from lists
- [ ] Sync lists as tags

### Phase 10: Polish
- [ ] Help documentation
- [ ] Keyboard shortcuts
- [ ] README

## API Reference

### Key Queries
- `me { id, username }` - Validate token, get user ID
- `user_books(where: {user_id: ...})` - Fetch user's library
- `editions(where: {isbn_13: ...})` - Lookup by ISBN
- `search(query: ..., query_type: "Book")` - Search by title/author

### Key Mutations
- `insert_user_book` / `update_user_book` - Update reading status
- `insert_list_book` / `delete_list_book` - Manage list membership

### Rate Limits
- 60 requests per minute
- 30 second query timeout
- Token expires yearly (resets Jan 1)

## Coexistence with Goodreads Sync

Both plugins can coexist because:
- Separate identifiers (`goodreads` vs `hardcover`)
- Separate config storage (`plugins/Goodreads Sync` vs `plugins/Hardcover Sync`)
- Separate custom columns (user configures independently)
- Independent toolbar menus
