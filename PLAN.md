# Hardcover Sync Plugin - Implementation Plan

A Calibre plugin for bidirectional sync with Hardcover.app, inspired by the Goodreads Sync plugin architecture but adapted for Hardcover's GraphQL API.

## Current Status

**Phases 1-9 Complete** | **96 tests passing** (17 integration tests skipped without API token)

- All core functionality implemented
- Only Phase 10 (Polish) remaining

## Overview

- **Authentication**: API Key (from https://hardcover.app/account/api)
- **API Format**: GraphQL via `gql[requests]` library
- **Identifier**: `hardcover` (book ID) and `hardcover-edition` (edition ID)
- **Sync Direction**: Bidirectional (Calibre ↔ Hardcover)
- **Book Creation**: Link only (no creating new books on Hardcover)

## Hardcover Reading Statuses

| ID | Status |
|----|--------|
| 1 | Want to Read |
| 2 | Currently Reading |
| 3 | Read |
| 4 | Paused |
| 5 | Did Not Finish |
| 6 | Ignored |

## Data Mapping

| Hardcover Field | Calibre Storage | Suggested Column |
|-----------------|-----------------|------------------|
| Book ID | Identifier: `hardcover` | - |
| Edition ID | Identifier: `hardcover-edition` | - |
| Status (1-6) | Custom enumeration column | `#hc_status` |
| Rating (0-5) | Rating column | `#hc_rating` |
| Progress (pages) | Custom integer column | `#hc_progress` |
| Date Started | Custom datetime column | `#hc_date_started` |
| Date Read | Custom datetime column | `#hc_date_read` |
| Review | Custom comments column | `#hc_review` |
| Lists | Tags or custom column | `tags` or `#hc_lists` |

Users manually create custom columns, then map them in plugin configuration (following Goodreads Sync pattern).

## Menu Structure

```
Hardcover (toolbar button)
├── Set Status →
│   ├── Want to Read
│   ├── Currently Reading
│   ├── Read
│   ├── Paused
│   ├── Did Not Finish
│   └── ─────────────
│   └── Remove from Hardcover
├── Update Reading Progress...
├── ─────────────
├── Sync from Hardcover...
├── Sync to Hardcover...
├── ─────────────
├── Lists →
│   ├── Add to List...
│   ├── Remove from List...
│   └── ─────────────
│   └── View Lists on Hardcover
├── ─────────────
├── Link to Hardcover...
├── View on Hardcover
├── Remove Hardcover Link
├── ─────────────
├── Customize plugin...
└── Help
```

## Conflict Resolution

When syncing bidirectionally and values differ:

| Strategy | Description |
|----------|-------------|
| `ask` | Ask user each time (default) |
| `hardcover` | Always use Hardcover value |
| `calibre` | Always use Calibre value |
| `newest` | Use whichever was updated more recently |

## Project Structure

```
plugins/hardcover-sync/
├── .calibre/
│   ├── justfile              # Calibre source download/setup
│   └── .gitignore
├── src/hardcover_sync/
│   ├── __init__.py           # InterfaceActionBase plugin entry
│   ├── _version.py           # Auto-generated by versioningit
│   ├── action.py             # InterfaceAction (menus, toolbar)
│   ├── config.py             # Configuration UI + prefs storage
│   ├── api.py                # HardcoverAPI client (using gql) + dry-run mode
│   ├── queries.py            # GraphQL queries/mutations
│   ├── cache.py              # ID caching (Hardcover ↔ Calibre)
│   ├── matcher.py            # Book matching logic
│   ├── images/
│   │   └── hardcover_sync.png  # Plugin icon
│   └── dialogs/
│       ├── __init__.py
│       ├── link_book.py      # Link to Hardcover dialog
│       ├── sync_from.py      # Sync from Hardcover dialog
│       ├── sync_to.py        # Sync to Hardcover dialog
│       ├── update_progress.py  # Update reading progress dialog
│       ├── add_to_list.py    # Add to list dialog
│       └── remove_from_list.py # Remove from list dialog
├── test/
│   ├── conftest.py           # Pytest config, calibre/Qt mocks
│   ├── test_api.py           # API client tests (31 tests)
│   ├── test_cache.py         # Cache tests (14 tests)
│   ├── test_matcher.py       # Matcher tests (17 tests)
│   ├── test_config.py        # Config tests (11 tests)
│   ├── test_sync.py          # Sync dataclass tests (11 tests)
│   ├── test_dialogs.py       # Dialog tests (12 tests)
│   └── test_integration.py   # Integration tests (17 tests, require API token)
├── scripts/
│   ├── build_env.py
│   ├── bundle.sh
│   └── bump.sh
├── shims/
│   └── pytest
├── .gitignore
├── .gitlint
├── .lefthook.yml
├── cliff.toml
├── justfile
├── mise.toml
├── pyproject.toml
├── PLAN.md
└── README.md
```

## Implementation Phases

### Phase 1: Project Setup ✅
- [x] `mise.toml` - Tool versions (Python 3.11, uv, just, git-cliff)
- [x] `pyproject.toml` - Package config, dependencies
- [x] `justfile` - Development tasks
- [x] `.calibre/justfile` - Calibre source setup
- [x] `scripts/bundle.sh` - Create distributable .zip
- [x] `.lefthook.yml`, `.gitlint`, `cliff.toml` - Git hooks & changelog
- [x] `.gitignore`
- [x] `shims/pytest` - Pytest wrapper

### Phase 2: Plugin Skeleton ✅
- [x] `src/hardcover_sync/__init__.py` - InterfaceActionBase
- [x] `src/hardcover_sync/action.py` - InterfaceAction with basic menu
- [x] `src/hardcover_sync/config.py` - Configuration widget stub
- [x] `images/hardcover_sync.png` - Placeholder icon
- [x] Verify plugin loads in Calibre

### Phase 3: API Client ✅
- [x] `src/hardcover_sync/api.py` - HardcoverAPI class with dry-run mode
- [x] `src/hardcover_sync/queries.py` - GraphQL queries/mutations
- [x] `test/test_api.py` - Mocked API tests (31 tests)
- [x] Token validation in config UI

### Phase 4: Book Linking ✅
- [x] `src/hardcover_sync/matcher.py` - ISBN lookup, title search
- [x] `src/hardcover_sync/cache.py` - ID cache management
- [x] `src/hardcover_sync/dialogs/link_book.py` - Link dialog
- [x] Store `hardcover` identifier

### Phase 5: Set Reading Status ✅
- [x] Status submenu with all 6 statuses
- [x] Call API to update status
- [x] Update Calibre status column
- [x] Remove from Hardcover action

### Phase 6: Configuration UI ✅
- [x] Token input + validation
- [x] Column mapping dropdowns (status, rating, progress, dates, review, lists)
- [x] Status value mapping UI
- [x] Conflict resolution setting
- [x] Sync option checkboxes
- [x] Three-tab layout (Account, Columns, Sync Options)

### Phase 7: Sync from Hardcover ✅
- [x] Fetch user's library
- [x] Match to Calibre books via `hardcover` identifier
- [x] Preview dialog with checkboxes
- [x] Apply changes to Calibre columns

### Phase 8: Sync to Hardcover ✅
- [x] Read Calibre values
- [x] Preview dialog showing changes
- [x] Push to API (update existing or add new)

### Phase 9: Progress & Lists ✅
- [x] Update progress dialog (`update_progress.py`)
- [x] Add to list dialog (`add_to_list.py`)
- [x] Remove from list dialog (`remove_from_list.py`)

### Phase 10: Polish
- [ ] Help documentation
- [ ] Keyboard shortcuts
- [ ] README.md
- [ ] Final testing in Calibre

## API Reference

### Key Queries
- `me { id, username }` - Validate token, get user ID
- `user_books(where: {user_id: ...})` - Fetch user's library
- `editions(where: {isbn_13: ...})` - Lookup by ISBN
- `search(query: ..., query_type: "Book")` - Search by title/author

### Key Mutations
- `insert_user_book` / `update_user_book` - Update reading status
- `insert_list_book` / `delete_list_book` - Manage list membership

### Rate Limits
- 60 requests per minute
- 30 second query timeout
- Token expires yearly (resets Jan 1)

## Testing

### Unit Tests (Mocked)

Run the unit tests without any API token:

```bash
source .venv/bin/activate
python -m pytest test/ -v
```

These tests mock all API calls and test the plugin logic in isolation.

### Integration Tests (Real API)

Integration tests run against the real Hardcover API using **read-only operations only**.
They are automatically skipped unless you provide an API token.

#### Setup

1. Get your API token from https://hardcover.app/account/api
2. Set the environment variable:

```bash
export HARDCOVER_API_TOKEN="your-token-here"
```

3. Run the tests:

```bash
python -m pytest test/test_integration.py -v
```

#### What Integration Tests Do

- **Authentication**: Verify token is valid
- **Book Search**: Search by title, ISBN lookup
- **User Library**: Read books from your library (read-only)
- **User Lists**: Read your lists (read-only)
- **Dry-Run Mutations**: Test mutation logic WITHOUT modifying data

#### Safety Guarantees

- All mutation tests use `dry_run=True` mode
- No books will be added, updated, or removed from your library
- No lists will be modified
- Only GET/query operations hit the real API

### Dry-Run Mode

The API client supports a `dry_run` mode for safe testing:

```python
from hardcover_sync.api import HardcoverAPI

# Create client in dry-run mode
api = HardcoverAPI(token="your-token", dry_run=True)

# Mutations are logged but NOT executed
api.add_book_to_library(book_id=123, status_id=1)
api.update_user_book(user_book_id=456, status_id=3)

# See what would have been done
for op in api.get_dry_run_log():
    print(f"{op['operation']}: {op['variables']}")
```

## Coexistence with Goodreads Sync

Both plugins can coexist because:
- Separate identifiers (`goodreads` vs `hardcover`)
- Separate config storage (`plugins/Goodreads Sync` vs `plugins/Hardcover Sync`)
- Separate custom columns (user configures independently)
- Independent toolbar menus
